#!/usr/bin/env bash
set -euo pipefail

./splash.sh

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Determine which profile to activate
PROFILE_NAME="${1:-}"
REPO_URL="${2:-}"

# Get the directory where this script lives
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROFILE_BASE=$(basename "$SCRIPT_DIR")

# If no profile specified, activate current profile
if [[ -z "$PROFILE_NAME" ]]; then
    echo "Activating current profile: $PROFILE_BASE"
    PROFILE_DIR="$SCRIPT_DIR"
else
    # Handle profile switching
    if [[ "$PROFILE_NAME" == "main" ]]; then
        PROFILE_DIR="$HOME/.me"
    else
        PROFILE_DIR="$HOME/.me.$PROFILE_NAME"
    fi

    # If repo URL provided, clone it first
    if [[ -n "$REPO_URL" ]]; then
        if [[ -d "$PROFILE_DIR" ]]; then
            echo -e "${YELLOW}Warning: Profile directory $PROFILE_DIR already exists${NC}"
            read -p "Overwrite? (y/N) " -n 1 -r
            echo
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                echo "Aborted"
                exit 0
            fi
            rm -rf "$PROFILE_DIR"
        fi
        echo "Cloning $REPO_URL to $PROFILE_DIR..."
        git clone "$REPO_URL" "$PROFILE_DIR"
    fi

    # Verify profile exists
    if [[ ! -d "$PROFILE_DIR" ]]; then
        echo -e "${RED}Error: Profile not found at $PROFILE_DIR${NC}"
        echo ""
        echo "Available profiles:"
        for dir in "$HOME"/.me*; do
            if [[ -d "$dir" ]] && [[ "$dir" != "$HOME/.me.bkp" ]]; then
                echo "  - $(basename "$dir")"
            fi
        done
        exit 1
    fi

    # Verify profile has plugins directory
    if [[ ! -d "$PROFILE_DIR/plugins" ]]; then
        echo -e "${YELLOW}Warning: Profile $PROFILE_NAME has no plugins/ directory${NC}"
        echo "Profile may not be properly configured"
    fi

    echo "Switching to profile: $PROFILE_NAME"
fi

# Export environment for plugins
export BACKUP_DIR="$HOME/.me.bkp"
export PROFILE_DIR

# Create backup directory if it doesn't exist
mkdir -p "$BACKUP_DIR"

echo ""
echo "Running plugins..."
echo ""

# Discover and run all plugins
plugin_count=0
if [[ -d "$PROFILE_DIR/plugins" ]]; then
    for plugin in "$PROFILE_DIR/plugins"/*.sh; do
        if [[ -f "$plugin" ]]; then
            plugin_name=$(basename "$plugin" .sh)
            echo "→ Running $plugin_name plugin..."
            if bash "$plugin"; then
                ((plugin_count++))
            else
                echo -e "${RED}✗ Plugin $plugin_name failed${NC}"
            fi
            echo ""
        fi
    done
else
    echo -e "${YELLOW}No plugins directory found in $PROFILE_DIR${NC}"
fi

echo ""
echo -e "${GREEN}✓ Profile activated${NC}"
if [[ $plugin_count -gt 0 ]]; then
    echo "  $plugin_count plugin(s) configured"
fi

# Show current profile info
echo ""
echo "Current profile: $(basename "$PROFILE_DIR")"
echo "Profile location: $PROFILE_DIR"
echo ""
echo "Available commands:"
echo "  ./itsame              - Activate current profile"
echo "  ./itsame <name>       - Switch to another profile"
echo "  ./rollback            - Restore original configs"
